rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow read, update: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null && request.auth.uid == userId;
      
      allow update: if (
        // Validate field types
        request.resource.data.xp is number &&
        request.resource.data.level is number &&
        request.resource.data.streak is number &&
        request.resource.data.lastActive is timestamp &&
        request.resource.data.createdAt is timestamp &&
        
        // Validate map fields
        request.resource.data.skills is map &&
        request.resource.data.completedLessons is map &&
        request.resource.data.lessonAttempts is map &&
        request.resource.data.lessonScores is map &&
        request.resource.data.achievements is map &&
        request.resource.data.preferences is map &&
        
        // Only allow specific fields to be updated
        request.resource.data.keys().hasOnly([
          'displayName',
          'email',
          'photoURL',
          'xp',
          'level',
          'streak',
          'skills',
          'completedLessons',
          'lessonAttempts',
          'lessonScores',
          'achievements',
          'lastActive',
          'createdAt',
          'preferences',
          'onboardingComplete',
          'lastUpdated',
          'overallProgress'
        ])
      );
    }
    
    match /users/{userId}/private/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}